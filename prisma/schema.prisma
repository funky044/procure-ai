// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// Authentication Models (NextAuth)
// ============================================================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================================================
// Core User Model
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String?
  image         String?
  role          UserRole  @default(REQUESTER)
  department    String?
  approvalLimit Float     @default(5000)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts            Account[]
  sessions            Session[]
  procurementRequests ProcurementRequest[]
  approvals           Approval[]
  messages            Message[]
  auditLogs           AuditLog[]
  notifications       Notification[]
  managedBudgets      Budget[]        @relation("BudgetManager")
}

enum UserRole {
  REQUESTER
  MANAGER
  PROCUREMENT_LEAD
  FINANCE
  ADMIN
  VENDOR
}

// ============================================================================
// Budget Management
// ============================================================================

model Budget {
  id              String       @id @default(cuid())
  name            String
  department      String
  fiscalYear      Int
  totalAmount     Float
  spentAmount     Float        @default(0)
  committedAmount Float        @default(0)
  alertThreshold  Float        @default(80)
  status          BudgetStatus @default(ACTIVE)
  
  managerId       String
  manager         User         @relation("BudgetManager", fields: [managerId], references: [id])
  
  requests        ProcurementRequest[]
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

enum BudgetStatus {
  ACTIVE
  FROZEN
  EXHAUSTED
  CLOSED
}

// ============================================================================
// Procurement Models
// ============================================================================

model ProcurementRequest {
  id          String        @id @default(cuid())
  requestNumber String      @unique @default(cuid())
  status      RequestStatus @default(DRAFT)
  stage       String        @default("initial")
  
  category    String?
  description String?
  quantity    Int?
  specifications Json?
  budget      Float?
  urgency     Urgency       @default(MEDIUM)
  deliveryDate DateTime?
  deliveryLocation String?
  
  userId      String
  user        User          @relation(fields: [userId], references: [id])
  
  budgetId    String?
  budgetAllocation Budget?  @relation(fields: [budgetId], references: [id])
  
  quotes      Quote[]
  selectedQuoteId String?
  
  negotiation Negotiation?
  contract    Contract?
  purchaseOrder PurchaseOrder?
  approvals   Approval[]
  messages    Message[]
  attachments Attachment[]
  auditLogs   AuditLog[]
  invoices    Invoice[]
  
  isRecurring Boolean       @default(false)
  recurringSchedule RecurringSchedule?
  parentRequestId String?
  parentRequest ProcurementRequest? @relation("RecurringOrders", fields: [parentRequestId], references: [id])
  childRequests ProcurementRequest[] @relation("RecurringOrders")
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

enum RequestStatus {
  DRAFT
  CLARIFYING
  SOURCING
  QUOTING
  NEGOTIATING
  REVIEWING
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PO_GENERATED
  ORDERED
  PARTIALLY_DELIVERED
  DELIVERED
  INVOICED
  PAID
  COMPLETED
  CANCELLED
}

enum Urgency {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// Recurring Orders
// ============================================================================

model RecurringSchedule {
  id            String    @id @default(cuid())
  requestId     String    @unique
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  frequency     RecurringFrequency
  interval      Int       @default(1)
  dayOfWeek     Int?
  dayOfMonth    Int?
  
  startDate     DateTime
  endDate       DateTime?
  nextRunDate   DateTime
  lastRunDate   DateTime?
  
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
}

// ============================================================================
// Attachments
// ============================================================================

model Attachment {
  id            String    @id @default(cuid())
  
  requestId     String?
  request       ProcurementRequest? @relation(fields: [requestId], references: [id])
  
  invoiceId     String?
  invoice       Invoice?  @relation(fields: [invoiceId], references: [id])
  
  filename      String
  originalName  String
  mimeType      String
  size          Int
  url           String
  
  aiAnalysis    Json?
  extractedText String?   @db.Text
  
  uploadedBy    String
  createdAt     DateTime  @default(now())
}

// ============================================================================
// Vendor Models
// ============================================================================

model Vendor {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  password          String?
  logo              String?
  rating            Float    @default(0)
  responseTime      String?
  specialty         String?
  verified          Boolean  @default(false)
  sustainabilityScore Int    @default(0)
  onTimeRate        Float    @default(0)
  categories        String[]
  address           String?
  paymentTerms      String   @default("Net 30")
  contactName       String?
  contactEmail      String?
  contactPhone      String?
  
  portalEnabled     Boolean  @default(false)
  lastLoginAt       DateTime?
  
  apiEnabled        Boolean  @default(false)
  apiEndpoint       String?
  apiKey            String?
  
  quotes            Quote[]
  negotiations      Negotiation[]
  contracts         Contract[]
  purchaseOrders    PurchaseOrder[]
  invoices          Invoice[]
  
  totalOrders       Int      @default(0)
  totalValue        Float    @default(0)
  avgDeliveryDays   Float?
  qualityScore      Float?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

// ============================================================================
// Quote Models
// ============================================================================

model Quote {
  id            String      @id @default(cuid())
  quoteNumber   String      @unique @default(cuid())
  
  vendorId      String
  vendor        Vendor      @relation(fields: [vendorId], references: [id])
  
  requestId     String
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  status        QuoteStatus @default(PENDING)
  unitPrice     Float
  totalPrice    Float
  quantity      Int
  deliveryDays  Int
  warranty      String?
  paymentTerms  String?
  notes         String?
  validUntil    DateTime
  isRecommended Boolean     @default(false)
  
  lineItems     Json?
  
  submittedAt   DateTime?
  viewedAt      DateTime?
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
}

enum QuoteStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  EXPIRED
}

// ============================================================================
// Negotiation Models
// ============================================================================

model Negotiation {
  id            String            @id @default(cuid())
  
  requestId     String            @unique
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  vendorId      String
  vendor        Vendor            @relation(fields: [vendorId], references: [id])
  
  status        NegotiationStatus @default(ACTIVE)
  originalPrice Float
  currentPrice  Float
  targetPrice   Float
  finalPrice    Float?
  
  rounds        NegotiationRound[]
  
  startedAt     DateTime          @default(now())
  completedAt   DateTime?
}

model NegotiationRound {
  id            String      @id @default(cuid())
  
  negotiationId String
  negotiation   Negotiation @relation(fields: [negotiationId], references: [id])
  
  round         Int
  ourOffer      Float
  vendorResponse Float?
  message       String
  vendorMessage String?
  status        RoundStatus @default(SENT)
  
  createdAt     DateTime    @default(now())
}

enum NegotiationStatus {
  ACTIVE
  ACCEPTED
  REJECTED
  EXPIRED
}

enum RoundStatus {
  SENT
  COUNTERED
  ACCEPTED
  REJECTED
}

// ============================================================================
// Contract Models
// ============================================================================

model Contract {
  id            String         @id @default(cuid())
  contractNumber String        @unique @default(cuid())
  
  requestId     String         @unique
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  vendorId      String
  vendor        Vendor         @relation(fields: [vendorId], references: [id])
  
  status        ContractStatus @default(DRAFT)
  items         Json
  totalValue    Float
  paymentTerms  String
  deliveryDate  DateTime
  warranty      String?
  terms         String[]
  
  buyerSignature    String?
  vendorSignature   String?
  
  approvedAt    DateTime?
  signedAt      DateTime?
  
  purchaseOrder PurchaseOrder?
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

enum ContractStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PENDING_VENDOR_SIGNATURE
  SIGNED
  CANCELLED
}

// ============================================================================
// Purchase Order Models
// ============================================================================

model PurchaseOrder {
  id            String    @id @default(cuid())
  poNumber      String    @unique
  
  requestId     String    @unique
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  contractId    String    @unique
  contract      Contract  @relation(fields: [contractId], references: [id])
  
  vendorId      String
  vendor        Vendor    @relation(fields: [vendorId], references: [id])
  
  status        POStatus  @default(GENERATED)
  
  shipToName    String
  shipToCompany String
  shipToStreet  String
  shipToCity    String
  shipToState   String
  shipToZip     String
  shipToCountry String    @default("USA")
  
  items         Json
  subtotal      Float
  tax           Float     @default(0)
  shipping      Float     @default(0)
  total         Float
  paymentTerms  String
  deliveryDate  DateTime
  
  trackingNumber String?
  carrierName    String?
  
  deliveries    Delivery[]
  invoices      Invoice[]
  
  sentAt        DateTime?
  acknowledgedAt DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum POStatus {
  GENERATED
  SENT
  ACKNOWLEDGED
  PROCESSING
  SHIPPED
  PARTIALLY_DELIVERED
  DELIVERED
  INVOICED
  PAID
  CLOSED
}

// ============================================================================
// Delivery Tracking
// ============================================================================

model Delivery {
  id            String        @id @default(cuid())
  
  poId          String
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  
  deliveryNumber String       @unique @default(cuid())
  status        DeliveryStatus @default(PENDING)
  
  items         Json
  
  trackingNumber String?
  carrierName   String?
  
  expectedDate  DateTime?
  shippedDate   DateTime?
  deliveredDate DateTime?
  
  receivedBy    String?
  notes         String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum DeliveryStatus {
  PENDING
  SHIPPED
  IN_TRANSIT
  OUT_FOR_DELIVERY
  DELIVERED
  RETURNED
}

// ============================================================================
// Invoice Models
// ============================================================================

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  
  vendorId      String
  vendor        Vendor        @relation(fields: [vendorId], references: [id])
  
  poId          String
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])
  
  requestId     String
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  status        InvoiceStatus @default(PENDING)
  
  invoiceDate   DateTime
  dueDate       DateTime
  
  items         Json
  subtotal      Float
  tax           Float         @default(0)
  total         Float
  
  poTotal       Float
  variance      Float         @default(0)
  varianceReason String?
  matchStatus   MatchStatus   @default(PENDING)
  
  paidAmount    Float         @default(0)
  paidDate      DateTime?
  paymentMethod String?
  paymentReference String?
  
  attachments   Attachment[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

enum InvoiceStatus {
  PENDING
  RECEIVED
  UNDER_REVIEW
  MATCHED
  DISPUTED
  APPROVED
  PAID
  CANCELLED
}

enum MatchStatus {
  PENDING
  MATCHED
  PARTIAL_MATCH
  MISMATCH
  EXCEPTION
}

// ============================================================================
// Approval Models
// ============================================================================

model Approval {
  id            String         @id @default(cuid())
  
  requestId     String
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  
  step          Int            @default(1)
  role          String
  status        ApprovalStatus @default(PENDING)
  threshold     Float?
  comments      String?
  
  escalatedAt   DateTime?
  escalatedTo   String?
  escalationReason String?
  
  delegatedBy   String?
  delegatedAt   DateTime?
  
  dueDate       DateTime?
  reminderSent  Boolean        @default(false)
  
  approvedAt    DateTime?
  createdAt     DateTime       @default(now())
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  DELEGATED
  SKIPPED
  EXPIRED
}

// ============================================================================
// Approval Rules
// ============================================================================

model ApprovalRule {
  id            String   @id @default(cuid())
  name          String
  description   String?
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  
  minAmount     Float?
  maxAmount     Float?
  categories    String[]
  departments   String[]
  
  approverRole  UserRole
  approverIds   String[]
  
  autoApprove   Boolean  @default(false)
  escalationHours Int    @default(48)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================================================
// Audit Trail
// ============================================================================

model AuditLog {
  id            String   @id @default(cuid())
  
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  requestId     String?
  request       ProcurementRequest? @relation(fields: [requestId], references: [id])
  
  action        String
  entity        String
  entityId      String
  
  previousData  Json?
  newData       Json?
  changes       Json?
  
  ipAddress     String?
  userAgent     String?
  
  createdAt     DateTime @default(now())
}

// ============================================================================
// Notifications
// ============================================================================

model Notification {
  id            String           @id @default(cuid())
  
  userId        String
  user          User             @relation(fields: [userId], references: [id])
  
  type          NotificationType
  title         String
  message       String
  link          String?
  
  isRead        Boolean          @default(false)
  readAt        DateTime?
  
  emailSent     Boolean          @default(false)
  emailSentAt   DateTime?
  
  createdAt     DateTime         @default(now())
}

enum NotificationType {
  APPROVAL_REQUIRED
  APPROVAL_COMPLETED
  QUOTE_RECEIVED
  PO_SENT
  PO_ACKNOWLEDGED
  DELIVERY_UPDATE
  INVOICE_RECEIVED
  INVOICE_MISMATCH
  BUDGET_ALERT
  RECURRING_ORDER
  SYSTEM
}

// ============================================================================
// Messages
// ============================================================================

model Message {
  id            String   @id @default(cuid())
  
  requestId     String
  request       ProcurementRequest @relation(fields: [requestId], references: [id])
  
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  
  type          String   @default("text")
  content       String?
  isUser        Boolean  @default(false)
  data          Json?
  
  createdAt     DateTime @default(now())
}

// ============================================================================
// Analytics
// ============================================================================

model SpendAnalytics {
  id            String   @id @default(cuid())
  
  period        String
  department    String?
  category      String?
  vendorId      String?
  
  totalSpend    Float    @default(0)
  orderCount    Int      @default(0)
  avgOrderValue Float    @default(0)
  savingsAmount Float    @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([period, department, category, vendorId])
}
